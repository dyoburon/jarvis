<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Jarvis Terminal</title>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css"
      integrity="sha384-tStR1zLfWgsiXCF3IgfB3lBa8KmBe/lG287CL9WCeKgQYcp1bjb4/+mwN6oti4Co"
      crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"
        integrity="sha384-J4qzUjBl1FxyLsl/kQPQIOeINsmp17OHYXDOMpMxlKX53ZfYsL+aWHpgArvOuof9"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"
        integrity="sha384-XGqKrV8Jrukp1NITJbOEHwg01tNkuXr6uB6YEj69ebpYU3v7FvoGgEg23C1Gcehk"
        crossorigin="anonymous"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html { background: transparent !important; overflow: hidden; }

body {
  background: var(--color-panel-bg, #242936);
  color: var(--color-text, #cccac2);
  font-family: var(--font-family, Menlo), monospace;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#terminal-container {
  flex: 1;
  padding: 4px;
  overflow: hidden;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(200, 204, 212, 0.3); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(200, 204, 212, 0.5); }

#exit-overlay {
  display: none;
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center; align-items: center;
  flex-direction: column; gap: 12px;
  font-family: var(--font-ui, sans-serif);
  z-index: 10;
}
#exit-overlay.visible { display: flex; }
#exit-overlay .exit-msg { color: var(--color-text-muted, #707a8c); font-size: 13px; }
#exit-overlay .restart-btn {
  background: transparent;
  border: 1px solid var(--color-border-focused, rgba(255,204,102,0.12));
  color: var(--color-text, #cccac2);
  font-family: var(--font-ui, sans-serif);
  font-size: 12px; padding: 6px 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 150ms ease;
}
#exit-overlay .restart-btn:hover { background: rgba(255, 204, 102, 0.08); }
</style>
</head>
<body>

<div id="terminal-container"></div>
<div id="exit-overlay">
  <div class="exit-msg">Process exited</div>
  <button class="restart-btn">Restart Shell</button>
</div>

<script>
'use strict';

// Ayu Mirage defaults — used immediately, updated when theme IPC arrives
var AYU = {
  background: '#242936',
  foreground: '#cccac2',
  cursor: '#ffcc66',
  cursorAccent: '#1f2430',
  selectionBackground: 'rgba(255, 204, 102, 0.25)',
  selectionForeground: '#ffffff',
  black: '#171b24',
  red: '#f28779',
  green: '#bae67e',
  yellow: '#ffd580',
  blue: '#73d0ff',
  magenta: '#d4bfff',
  cyan: '#95e6cb',
  white: '#cccac2',
  brightBlack: '#707a8c',
  brightRed: '#f28779',
  brightGreen: '#bae67e',
  brightYellow: '#ffd580',
  brightBlue: '#73d0ff',
  brightMagenta: '#d4bfff',
  brightCyan: '#95e6cb',
  brightWhite: '#f3f4f5'
};

var container = document.getElementById('terminal-container');
var term = new Terminal({
  cursorBlink: true,
  cursorStyle: 'block',
  scrollback: 10000,
  fontSize: 13,
  fontFamily: "'Menlo', monospace",
  lineHeight: 1.6,
  fontWeight: '400',
  fontWeightBold: '700',
  allowProposedApi: true,
  theme: AYU
});

var fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);
term.open(container);
fitAddon.fit();

var ro = new ResizeObserver(function() {
  try { fitAddon.fit(); } catch (e) { /* ignore */ }
});
ro.observe(container);

term.onData(function(data) {
  if (window.jarvis && window.jarvis.ipc) {
    window.jarvis.ipc.send('pty_input', { data: data });
  }
});

term.onResize(function(size) {
  if (window.jarvis && window.jarvis.ipc) {
    window.jarvis.ipc.send('pty_resize', { cols: size.cols, rows: size.rows });
  }
});

// Notify Rust terminal is ready
if (window.jarvis && window.jarvis.ipc) {
  window.jarvis.ipc.send('terminal_ready', { cols: term.cols, rows: term.rows });
}

// Theme IPC — update xterm when config arrives/changes
if (window.jarvis && window.jarvis.ipc) {
  window.jarvis.ipc.on('theme', function(payload) {
    if (!payload) return;
    if (payload.xterm) term.options.theme = payload.xterm;
    if (payload.fontSize) term.options.fontSize = payload.fontSize;
    if (payload.fontFamily) term.options.fontFamily = payload.fontFamily;
    if (payload.lineHeight) term.options.lineHeight = payload.lineHeight;
    if (payload.fontWeight) term.options.fontWeight = String(payload.fontWeight);
    if (payload.fontWeightBold) term.options.fontWeightBold = String(payload.fontWeightBold);
    if (payload.cursorStyle) term.options.cursorStyle = payload.cursorStyle;
    if (payload.cursorBlink !== undefined) term.options.cursorBlink = payload.cursorBlink;
    if (payload.scrollback !== undefined) term.options.scrollback = payload.scrollback;
    try { fitAddon.fit(); } catch (e) { /* ignore */ }
  });

  window.jarvis.ipc.on('pty_output', function(payload) {
    if (payload && payload.data) term.write(payload.data);
  });

  window.jarvis.ipc.on('pty_exit', function(payload) {
    var overlay = document.getElementById('exit-overlay');
    if (overlay) {
      var msg = overlay.querySelector('.exit-msg');
      if (msg && payload && payload.code !== undefined) {
        msg.textContent = 'Process exited (code ' + payload.code + ')';
      }
      overlay.classList.add('visible');
    }
  });
}

// Also check for globally stored theme (set by evaluate_script before page loaded)
if (window.__jarvis_theme) {
  var p = window.__jarvis_theme;
  if (p.xterm) term.options.theme = p.xterm;
  if (p.fontSize) term.options.fontSize = p.fontSize;
  if (p.fontFamily) term.options.fontFamily = p.fontFamily;
  if (p.lineHeight) term.options.lineHeight = p.lineHeight;
  try { fitAddon.fit(); } catch (e) { /* ignore */ }
}

// Focus management
document.addEventListener('mousedown', function() {
  if (window.jarvis && window.jarvis.ipc) window.jarvis.ipc.send('panel_focus', {});
});

function setFocused(isFocused) {
  if (isFocused) { term.focus(); }
}

// Restart button
document.querySelector('.restart-btn').addEventListener('click', function() {
  document.getElementById('exit-overlay').classList.remove('visible');
  term.clear();
  if (window.jarvis && window.jarvis.ipc) {
    window.jarvis.ipc.send('pty_restart', { cols: term.cols, rows: term.rows });
  }
});

setTimeout(function() { term.focus(); }, 120);
</script>
</body>
</html>
