# PLAN: Full Audit Remediation — jarvis-rs
Date: 2026-02-27
Status: Draft

## REQUIRED SKILLS — LOAD BEFORE PROCEEDING
skill({ name: "modular" })
skill({ name: "rust-audit" })
skill({ name: "rust-performance" })
skill({ name: "security-universal" })
skill({ name: "error-handling-universal" })
skill({ name: "testing-strategy" })

## Overview
Remediation plan for all findings from the 7-agent DEEP audit of jarvis-rs.
Organized into 6 phases by priority and dependency order.
Each phase has a clear pass criteria and test requirement.

## Context
The full audit surfaced ~149 findings across 7 agents:
- ~19 CRITICAL: RCE, secrets exposure, data loss, hangs
- ~45 HIGH: panics in production, missing auth, race conditions
- ~56 MEDIUM: quality, compat, privacy, performance
- ~29 LOW: naming, docs, minor issues

This plan addresses CRITICAL and HIGH first, then MEDIUM, then LOW.

## Scope
- In scope: All CRITICAL and HIGH findings across all 7 agents
- In scope: MEDIUM findings that are security or data-loss related
- Out of scope: LOW findings (tracked separately, addressed in normal dev)
- Out of scope: Feature additions (new platform backends, new tests for untested crates)

---

## Implementation Phases

### Phase 1: CRITICAL Security — Stop the Bleeding
**Priority: P0 — Do immediately. Every day unfixed is a liability.**

#### 1A. AI Tool Sandbox (Alpha-Sec Finding 1, 4)
- **File:** `crates/jarvis-ai/src/tools.rs`
- **What:**
  - `run_command` tool: Add command allowlist, require user confirmation, use `Command::new(prog).args()` not shell, restrict working directory
  - `read_file` / `write_file` tools: Add path sandboxing via `canonicalize()` + `starts_with(allowed_dir)`, deny `~/.ssh`, `~/.aws`, `~/.gnupg`, `.env` etc.
  - `list_files` tool: Same path sandboxing
- **Test:** Unit test that blocked commands are rejected, blocked paths return error, allowed operations succeed
- **Pass criteria:** `cargo test -p jarvis-ai -- tools` passes, no `Command::new("sh")` in codebase

#### 1B. Gemini API Key Out of URL (Alpha-Sec 2, Delta-Data 1-2, Charlie-Infra 4)
- **File:** `crates/jarvis-ai/src/gemini.rs`
- **What:** Move API key from URL query param to `x-goog-api-key` HTTP header for both `api_url()` and streaming URL
- **Test:** Unit test that constructed request has header, not query param
- **Pass criteria:** No `?key=` in any URL construction

#### 1C. HTTP Timeouts (Charlie-Infra 2)
- **Files:** `crates/jarvis-ai/src/claude.rs`, `gemini.rs`, `whisper.rs`
- **What:** Replace `reqwest::Client::new()` with builder: `connect_timeout(10s)`, `timeout(120s)`
- **Test:** Integration test with mock server that hangs — verify timeout fires
- **Pass criteria:** No `Client::new()` in production code

#### 1D. WebSocket Timeout (Charlie-Infra 3)
- **File:** `crates/jarvis-social/src/realtime.rs`
- **What:** Wrap `connect_async()` in `tokio::time::timeout(15s, ...)`
- **Test:** Unit test that connection timeout produces error, not hang
- **Pass criteria:** No bare `connect_async` without timeout wrapper

#### 1E. Graceful Shutdown (Charlie-Infra 1, Bravo-Qual)
- **File:** `crates/jarvis-app/src/main.rs`
- **What:** Replace `process::exit(0)` with CancellationToken or EventLoopProxy signal. Let Drop impls run.
- **Test:** Manual verification that PTY processes are killed on Ctrl+C
- **Pass criteria:** No `process::exit` in codebase

#### 1F. PTY Read Data Loss (Golf-Logic)
- **File:** `crates/jarvis-terminal/src/pty.rs`
- **What:** Add `pending: Vec<u8>` field to PtyManager. Buffer remainder when read buf is smaller than received data.
- **Test:** Unit test: send 8192 bytes, read with 4096 buffer twice, verify all bytes received
- **Pass criteria:** `cargo test -p jarvis-terminal -- pty` passes

---

### Phase 2: HIGH Security & Data Privacy
**Priority: P1 — Fix within 1 week**

#### 2A. Redact Secrets from Debug (Alpha-Sec 9, Delta-Data 5-7)
- **Files:** `claude.rs`, `gemini.rs`, `whisper.rs`, `realtime.rs`, `identity.rs`
- **What:** Replace `#[derive(Debug)]` with manual `impl Debug` that prints `[REDACTED]` for: `api_key`, `oauth_token`, `access_token`
- **Test:** Unit test: `format!("{:?}", config)` does not contain any key value
- **Pass criteria:** No `#[derive(Debug)]` on any struct containing secret fields

#### 2B. Stop Logging Secrets (Alpha-Sec 5, Delta-Data 8)
- **File:** `crates/jarvis-social/src/realtime.rs:324`
- **What:** Redact URL before logging: `url.split('?').next()`
- **Test:** Grep for `info!` calls that include URLs with query params
- **Pass criteria:** No `apikey=` in any log output

#### 2C. Stop Logging PII (Delta-Data 4-5)
- **Files:** `crates/jarvis-app/src/app_state.rs:160`, `crates/jarvis-platform/src/notifications.rs:35`
- **What:** Remove chat content and notification body from INFO logs. Log only metadata (message count, notification type).
- **Test:** Grep for `tracing::info!` calls containing user-controlled content
- **Pass criteria:** No user content at INFO level

#### 2D. WebView Navigation Allowlist (Alpha-Sec 6)
- **File:** `crates/jarvis-webview/src/manager.rs`
- **What:** Replace `true` navigation handler with allowlist: `https://`, `jarvis://` only. Block `file://`, `javascript:`, internal networks.
- **Test:** Unit test: blocked URLs return false
- **Pass criteria:** No `true` in navigation handler

#### 2E. IPC Validation (Alpha-Sec 7)
- **File:** `crates/jarvis-webview/src/manager.rs`, `ipc.rs`
- **What:** Validate IPC messages against `IpcMessage` schema before forwarding. Reject unknown kinds.
- **Test:** Unit test: malformed IPC message is rejected
- **Pass criteria:** All IPC messages parsed and validated before processing

#### 2F. Content Provider Symlink Fix (Alpha-Sec 13, Delta-Data)
- **File:** `crates/jarvis-webview/src/content.rs`
- **What:** Use `canonicalize()` on both base_dir and file_path before `starts_with` check
- **Test:** Unit test: symlink traversal attempt returns PathTraversal error
- **Pass criteria:** `canonicalize` used in path validation

#### 2G. CORS Restriction (Alpha-Sec 12)
- **File:** `crates/jarvis-webview/src/manager.rs`
- **What:** Change `Access-Control-Allow-Origin: *` to `jarvis://localhost`
- **Test:** Verify response header in unit test
- **Pass criteria:** No `"*"` in CORS headers

#### 2H. Identity Auth (Alpha-Sec 10)
- **File:** `crates/jarvis-social/src/identity.rs`
- **What:** Create `PublicIdentity` (no token) for broadcast. Never serialize `access_token`.
- **Test:** Unit test: serialized identity does not contain access_token
- **Pass criteria:** `#[serde(skip)]` on access_token

---

### Phase 3: Performance & Correctness
**Priority: P1 — Fix within 1 week (some are data-loss bugs)**

#### 3A. Scrollback VecDeque (Bravo-Qual, Echo-Perf, Golf-Logic)
- **File:** `crates/jarvis-terminal/src/scrollback.rs`
- **What:** Replace `Vec<Vec<Cell>>` with `VecDeque<Vec<Cell>>`. Use `pop_front()` + `push_back()`.
- **Test:** Existing scrollback tests pass. Add benchmark showing O(1) vs O(n).
- **Pass criteria:** `cargo test -p jarvis-terminal -- scrollback` passes. No `Vec::remove(0)`.

#### 3B. Grid scroll_up Fix (Echo-Perf)
- **File:** `crates/jarvis-terminal/src/grid.rs`
- **What:** Replace `self.cells.remove(0)` with `VecDeque` or rotate pattern
- **Test:** Existing grid tests pass
- **Pass criteria:** No `remove(0)` on Vec in grid.rs

#### 3C. Token Usage u64 (Golf-Logic)
- **File:** `crates/jarvis-ai/src/lib.rs`, `claude.rs`, `gemini.rs`
- **What:** Change `TokenUsage` fields from `u32` to `u64`. Use `saturating_add` in `total_tokens()`.
- **Test:** Unit test: large token values don't overflow
- **Pass criteria:** No `u32` in TokenUsage. `saturating_add` used.

#### 3D. Tiling Sentinel Fix (Golf-Logic)
- **File:** `crates/jarvis-tiling/src/tree.rs`
- **What:** Replace sentinel-based swap with direct leaf swap (single pass, no magic value)
- **Test:** Unit test: swap with pane ID u32::MAX works correctly
- **Pass criteria:** No `u32::MAX` sentinel in swap logic

#### 3E. Layout Negative Dimensions (Golf-Logic)
- **File:** `crates/jarvis-tiling/src/layout.rs`
- **What:** Clamp `(bounds.width - gap).max(0.0)` and `(bounds.height - gap).max(0.0)`
- **Test:** Unit test: layout with bounds smaller than gap produces zero-size, not negative
- **Pass criteria:** `.max(0.0)` on all dimension calculations

#### 3F. VTE Allocations (Echo-Perf)
- **File:** `crates/jarvis-terminal/src/vte_handler.rs`
- **What:** Replace `params.iter().map(...).collect::<Vec<_>>()` with iterator-based processing. No allocation per CSI dispatch.
- **Test:** Existing VTE tests pass
- **Pass criteria:** No `collect()` in `csi_dispatch` or `sgr_dispatch`

#### 3G. Race Conditions — Pair/Voice Dual Maps (Golf-Logic)
- **Files:** `crates/jarvis-social/src/pair.rs`, `voice.rs`
- **What:** Combine `sessions` + `user_sessions` into single `RwLock<PairState>` struct. Same for voice rooms.
- **Test:** Unit test: concurrent join/leave doesn't corrupt state
- **Pass criteria:** Single lock per logical state group

---

### Phase 4: Infrastructure & Compatibility
**Priority: P2 — Fix within 2 weeks**

#### 4A. Release Profile (Charlie-Infra)
- **File:** `Cargo.toml` (workspace root)
- **What:** Add `[profile.release]` with `lto = "thin"`, `codegen-units = 1`, `strip = "symbols"`, `panic = "abort"`
- **Test:** `cargo build --release` succeeds
- **Pass criteria:** Release profile exists

#### 4B. Paths Return Result (Charlie-Infra, Foxtrot-Compat)
- **File:** `crates/jarvis-platform/src/paths.rs`
- **What:** Change `config_dir()`, `data_dir()`, `cache_dir()` from `expect()` to return `Result<PathBuf, PlatformError>`
- **Test:** Unit test: function returns error when dirs unavailable
- **Pass criteria:** No `.expect()` in paths.rs

#### 4C. Config Validation — Don't Discard (Charlie-Infra)
- **File:** `crates/jarvis-config/src/toml_loader.rs`
- **What:** On validation failure, clamp invalid values to valid ranges instead of discarding entire config. Remove TOCTOU `exists()` check.
- **Test:** Unit test: invalid font size gets clamped, valid fields preserved
- **Pass criteria:** No `return Ok(JarvisConfig::default())` on validation failure

#### 4D. Config Schema Migration (Foxtrot-Compat)
- **File:** `crates/jarvis-config/src/schema.rs`, `toml_loader.rs`
- **What:** Read raw TOML first, check `config_version`, run migrations if needed, then deserialize
- **Test:** Unit test: v1 config loaded and migrated to current version
- **Pass criteria:** `CONFIG_SCHEMA_VERSION` is checked during load

#### 4E. Event Forward Compatibility (Foxtrot-Compat)
- **File:** `crates/jarvis-common/src/events.rs`
- **What:** Add `#[serde(other)] Unknown` variant to Event enum
- **Test:** Unit test: unknown event type deserializes as Unknown, not error
- **Pass criteria:** `Unknown` variant exists with `#[serde(other)]`

#### 4F. Platform Defaults (Foxtrot-Compat)
- **File:** `crates/jarvis-config/src/schema.rs`
- **What:** Use `#[cfg(target_os)]` for default font family and keybind modifier
- **Test:** Compile test on non-macOS (or cfg-gated unit tests)
- **Pass criteria:** Default font is not "Menlo" on Linux/Windows

#### 4G. Remove serde_yaml (Charlie-Infra)
- **File:** `Cargo.toml`, theme.rs
- **What:** Replace deprecated `serde_yaml` with `serde_yml` or remove YAML support
- **Test:** Theme loading tests pass
- **Pass criteria:** No `serde_yaml` in Cargo.toml

#### 4H. GPU Fallback Adapter (Foxtrot-Compat, Charlie-Infra)
- **File:** `crates/jarvis-renderer/src/gpu.rs`
- **What:** Try hardware adapter first, then fallback with `force_fallback_adapter: true`
- **Test:** Manual test on headless system
- **Pass criteria:** Two adapter requests in code

#### 4I. Updater Semver (Golf-Logic)
- **File:** `crates/jarvis-app/src/updater.rs`
- **What:** Add `semver` crate dependency. Use `semver::Version::parse` for comparison.
- **Test:** Unit test: "1.0.0-beta.1" < "1.0.0-beta.2" < "1.0.0"
- **Pass criteria:** `semver` crate used for version comparison

#### 4J. .gitignore (Charlie-Infra)
- **File:** `.gitignore` (new)
- **What:** Add `/target`, `.env`, `.DS_Store`, `*.log`, `.idea/`, `.vscode/`
- **Test:** `git status` doesn't show target/
- **Pass criteria:** .gitignore exists

---

### Phase 5: Code Quality & Maintainability
**Priority: P2 — Fix within 2 weeks**

#### 5A. Split schema.rs (Bravo-Qual)
- **File:** `crates/jarvis-config/src/schema.rs` (1823 lines)
- **What:** Split into: `schema/mod.rs`, `schema/font.rs`, `schema/ai.rs`, `schema/visual.rs`, `schema/terminal.rs`, `schema/tiling.rs`, `schema/social.rs`, `schema/keybinds.rs`
- **Test:** All existing config tests pass
- **Pass criteria:** No file > 300 lines in schema/

#### 5B. Split app_state.rs (Bravo-Qual)
- **File:** `crates/jarvis-app/src/app_state.rs` (724 lines)
- **What:** Extract: `event_handler.rs`, `pty_bridge.rs`, action handlers by domain
- **Test:** Application builds and runs
- **Pass criteria:** No file > 300 lines

#### 5C. Split grid.rs (Bravo-Qual)
- **File:** `crates/jarvis-terminal/src/grid.rs` (1027 lines)
- **What:** Extract: `cell.rs` (Cell, CellAttributes, TerminalColor), `cursor.rs`
- **Test:** All terminal tests pass
- **Pass criteria:** grid.rs < 500 lines

#### 5D. Fix unwrap() in Production (Bravo-Qual)
- **Files:** `paths.rs`, `input_processor.rs:170`, `app_state.rs:507`, `manager.rs:189,295,301`, `session.rs:112`
- **What:** Replace each `.unwrap()` with `?`, `.unwrap_or_default()`, or proper error handling
- **Test:** Grep confirms no `.unwrap()` outside `#[cfg(test)]`
- **Pass criteria:** Zero `.unwrap()` in non-test code (stretch goal)

#### 5E. Add Drop for PtyManager (Bravo-Qual)
- **File:** `crates/jarvis-terminal/src/pty.rs`
- **What:** `impl Drop for PtyManager` — kill child process, signal reader thread to stop
- **Test:** Unit test: dropping PtyManager kills child process
- **Pass criteria:** `impl Drop` exists

#### 5F. Reduce connection_loop Complexity (Bravo-Qual)
- **File:** `crates/jarvis-social/src/realtime.rs`
- **What:** Extract `spawn_heartbeat()`, `spawn_command_forwarder()`, `process_incoming_messages()`, `rejoin_channels()`
- **Test:** Existing social tests pass (if any) + app runs
- **Pass criteria:** No function > 100 lines in realtime.rs

---

### Phase 6: Privacy & Compliance
**Priority: P2 — Fix within 2 weeks**

#### 6A. AI PII Warning (Delta-Data)
- **Files:** `crates/jarvis-ai/src/session.rs`, `tools.rs`
- **What:** Add user-visible warning that conversation content is sent to third-party APIs. Add PII pattern detection before sending (credit cards, SSN, emails with regex).
- **Test:** Unit test: message containing credit card pattern triggers warning
- **Pass criteria:** Warning mechanism exists

#### 6B. Pair Programming Content Warning (Delta-Data)
- **File:** `crates/jarvis-social/src/pair.rs`
- **What:** Add prominent warning before pair session that terminal I/O is broadcast. Consider content filtering for known secret patterns.
- **Test:** Unit test: pair session emits warning event on creation
- **Pass criteria:** Warning event emitted

#### 6C. Crash Report Sanitization (Alpha-Sec 18, Delta-Data)
- **File:** `crates/jarvis-platform/src/crash_report.rs`
- **What:** Redact known secret patterns (sk-, ghp_, Bearer, API keys) from crash report content. Set 0600 permissions on crash files.
- **Test:** Unit test: crash report with secret patterns has them redacted
- **Pass criteria:** Regex redaction applied to crash output

#### 6D. Log Redaction Layer (Delta-Data)
- **File:** `crates/jarvis-app/src/main.rs`
- **What:** Wire `logging.redact_secrets` config to a tracing Layer that strips secret patterns
- **Test:** Unit test: log output with API key has it redacted
- **Pass criteria:** `redact_secrets` config option is functional

#### 6E. Identity Encryption at Rest (Delta-Data)
- **File:** `crates/jarvis-platform/src/paths.rs`, `crates/jarvis-social/src/identity.rs`
- **What:** Store identity.json with 0600 permissions. Consider OS keychain for access_token.
- **Test:** File permissions test after identity write
- **Pass criteria:** identity.json has restricted permissions

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Phase 1 changes break AI tools | High | Feature flag new sandbox, test with real AI calls |
| Scrollback VecDeque breaks terminal tests | Medium | Run all terminal tests after each change |
| Config migration logic has edge cases | Medium | Test with real user configs from current version |
| Removing process::exit causes hang on shutdown | Medium | Test Ctrl+C manually, add timeout fallback |
| Split files break imports | Low | Use barrel files (mod.rs re-exports) |
| Identity auth changes break existing sessions | Medium | Add migration path for existing identity.json |

## Rollback Plan
- Each phase is a separate branch/PR
- Revert entire phase if any test fails after merge
- Config changes are backwards-compatible (serde default)
- No destructive data migrations

## Success Criteria
- [ ] Zero CRITICAL findings remaining
- [ ] Zero HIGH findings remaining
- [ ] All existing tests pass (`cargo test --workspace`)
- [ ] `cargo clippy -- -D warnings` passes
- [ ] No `.unwrap()` in production code (outside tests)
- [ ] No secrets in log output at any level
- [ ] No API keys in URL query parameters
- [ ] All HTTP clients have timeouts
- [ ] All paths return Result, not panic
- [ ] schema.rs split into < 300 line files

## Estimated Effort
| Phase | Effort | Priority |
|-------|--------|----------|
| Phase 1: Critical Security | 2-3 days | P0 — Immediate |
| Phase 2: High Security/Privacy | 2-3 days | P1 — This week |
| Phase 3: Performance/Correctness | 2-3 days | P1 — This week |
| Phase 4: Infrastructure/Compat | 3-4 days | P2 — Next 2 weeks |
| Phase 5: Code Quality | 3-4 days | P2 — Next 2 weeks |
| Phase 6: Privacy/Compliance | 2-3 days | P2 — Next 2 weeks |
| **Total** | **~15-20 days** | |

## Approval
- [ ] User approved this plan
