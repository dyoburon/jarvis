# PLAN: Jarvis UX & Efficiency Improvements

Date: 2026-02-25
Status: Draft
Author: Orion (Audit)

## REQUIRED SKILLS - LOAD BEFORE PROCEEDING

```python
skill({ name: "modular" })
skill({ name: "error-handling-universal" })
skill({ name: "production-readiness" })
```

## Overview

Improve install experience, efficiency, and polish for the Jarvis personal AI assistant. Focus on high-impact, low-risk changes that make the app feel production-ready rather than barebones.

## Context

Jarvis is a personal AI assistant with voice control and Metal-rendered HUD. Current state:
- Works but feels "raw" and "barebones"
- No setup script — manual steps required
- Missing dependencies in requirements.txt
- Silent failures when services unavailable
- Performance issues with SQLite and HTTP connections

## Scope

### In Scope
- Fix missing dependencies
- Add setup.sh with pre-flight validation
- Add pre-flight checks at startup
- Improve error messages
- Add connection pooling for SQLite and HTTP
- Add `--version` and status commands

### Out of Scope
- Full main.py refactor (1,735 lines → modules) — too risky for this pass
- Removing duplicated command detection — can be done later
- Metal app changes — Swift changes out of scope

## Implementation Phases

### Phase 1: Fix Dependencies & Add Setup Script

**Goal:** Anyone can clone and run with one command.

**Steps:**
1. Add missing dependencies to requirements.txt:
   - `claude-agent-sdk>=0.1.41`
   - `aiohttp>=3.9`
2. Create `setup.sh` that:
   - Checks Python version (3.10+)
   - Creates venv if missing
   - Installs dependencies
   - Copies `.env.example` to `.env` if missing
   - Builds Metal app (`cd metal-app && swift build`)
   - Validates Metal app exists after build
3. Update README with simpler instructions

**Files Changed:**
- `requirements.txt` (add 2 lines)
- `setup.sh` (new file, ~60 lines)
- `README.md` (update install section)

**Test:**
```bash
# Fresh clone test
cd /tmp && git clone <repo> jarvis-test && cd jarvis-test
./setup.sh
./start.sh
# Expect: Jarvis starts successfully
```

**Pass Criteria:**
- `./setup.sh` succeeds on fresh clone
- `./start.sh` works after setup
- All imports resolve without errors

---

### Phase 2: Pre-flight Checks & Better Errors

**Goal:** Fail fast with actionable messages when something is wrong.

**Steps:**
1. Add `validate_startup()` function in `main.py` that checks:
   - Metal app exists (`metal-app/.build/debug/JarvisBootup`)
   - `.env` file exists
   - Warn if `GOOGLE_API_KEY` not set (not fatal)
   - Warn if vibetotext socket not available (not fatal)
2. Improve error messages with actionable guidance:
   - Metal app missing → "Run: ./setup.sh or cd metal-app && swift build"
   - Missing API key → "Get key at https://aistudio.google.com/apikey"
   - vibetotext down → "Start with: vibetotext serve"
3. Update `start.sh` to check venv exists before activating

**Files Changed:**
- `main.py` (add `validate_startup()`, ~40 lines)
- `start.sh` (add venv check, ~10 lines)

**Test:**
```bash
# Test 1: Metal app missing
rm metal-app/.build/debug/JarvisBootup
./start.sh
# Expect: Clear error message with fix instructions

# Test 2: Fresh start (after fixing)
./setup.sh
./start.sh
# Expect: Works normally
```

**Pass Criteria:**
- Missing Metal app shows actionable error
- Missing venv shows actionable error
- All warnings include next steps

---

### Phase 3: Connection Pooling & Performance

**Goal:** Reduce latency and resource waste.

**Steps:**
1. **SQLite connection pooling** (`connectors/sqlite_reader.py`):
   - Keep single connection per database
   - Add `close()` method for cleanup
   - Run queries in thread pool executor (don't block event loop)
2. **HTTP client reuse** (`connectors/http_client.py`):
   - Keep single `AsyncClient` instance
   - Add connection pool limits (max 10 connections)
   - Add `close()` method for cleanup
3. **Chat monitor session reuse** (`main.py:1318-1343`):
   - Create session once, reuse on reconnect
   - Add exponential backoff (1s → 30s max)

**Files Changed:**
- `connectors/sqlite_reader.py` (~30 lines changed)
- `connectors/token_tracker.py` (~20 lines changed)
- `connectors/http_client.py` (~25 lines changed)
- `main.py` (chat_monitor function, ~15 lines changed)

**Test:**
```bash
# Performance test
./start.sh
# Use voice to trigger domain/paper queries
# Check logs for query times (should be faster)
```

**Pass Criteria:**
- SQLite queries use pooled connection
- HTTP requests reuse connections
- No event loop blocking warnings in logs

---

### Phase 4: UX Polish

**Goal:** Make the app feel less "raw".

**Steps:**
1. Add `--version` flag to `main.py`:
   ```python
   if "--version" in sys.argv:
       print("Jarvis v1.0.0")
       sys.exit(0)
   ```
2. Add startup banner with status:
   ```
   ╔══════════════════════════════════════════════════════════╗
   ║  JARVIS v1.0.0                                           ║
   ║  ─────────────────────────────────────────────────────  ║
   ║  ✓ Metal display ready                                   ║
   ║  ✓ Voice capture ready                                   ║
   ║  ✓ Gemini API connected                                  ║
   ║  ○ VibeToText not running (optional)                     ║
   ╚══════════════════════════════════════════════════════════╝
   ```
3. Move hardcoded localhost URLs to environment variables with defaults
4. Add panel limit constant (`MAX_PANELS = 5`)

**Files Changed:**
- `main.py` (add version flag, startup banner, ~30 lines)
- `config.py` (make URLs configurable, ~10 lines)

**Test:**
```bash
./start.sh
# Expect: Nice startup banner with service status
python main.py --version
# Expect: "Jarvis v1.0.0"
```

**Pass Criteria:**
- `--version` flag works
- Startup shows status of all services
- URLs configurable via environment

---

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Connection pooling breaks SQLite | High | Low | Keep fallback to per-query mode |
| Setup script fails on different macOS | Medium | Medium | Test on clean macOS, add error handling |
| Performance changes introduce bugs | Medium | Low | Test all skills after changes |

## Rollback Plan

All changes are in separate phases. If a phase causes issues:
```bash
git revert HEAD~N  # Where N is the number of commits for that phase
```

## Success Criteria

- [ ] `./setup.sh` works on fresh clone
- [ ] Missing dependencies are installed automatically
- [ ] Clear error messages when services are unavailable
- [ ] SQLite queries are 5-10x faster
- [ ] HTTP requests reuse connections
- [ ] Startup banner shows service status
- [ ] `--version` flag works

## Approval

- [ ] User approved this plan

---

## Appendix: Full Audit Findings

### Bravo-Qual (Code Quality)
- **Critical (6):** File size violations (main.py 1,735 lines, main() 1,480 lines)
- **High (8):** Code duplication (12 command detection functions), empty catch blocks, magic numbers
- **Medium (6):** Naming issues, missing type hints, missing documentation

### Charlie-Infra (Infrastructure)
- **Critical (2):** Missing dependencies in requirements.txt, no Metal app validation
- **High (5):** No config validation, no service checks, silent failures
- **Medium (6):** Poor start.sh/login.sh UX, hardcoded URLs

### Echo-Perf (Performance)
- **Critical (2):** SQLite connection per query, blocking I/O in async
- **High (5):** HTTP client per request, unbounded audio queue, repeated subprocess
- **Medium (4):** Blocking subprocess, string concatenation, heavy imports

### Deferred to Future Work
- Refactor main.py into modules (too risky for this pass)
- Extract duplicated command detection into dispatch table
- Add connection pooling to ClaudeProxyClient
- Add bounded queues for audio capture
